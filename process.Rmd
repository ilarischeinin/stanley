---
title: "NHL Stanley Cup Playoff Predictions"
author: "Ilari Scheinin"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

Previous: [1. Scrape raw data](scrape.html)  
Next: [3. Train models](model.html)

3. Process data
---------------

This script reads the data files produced by nhlscrapr and generates a summary
of each team's performance in the regular season each year.

First, load packages and the Canadian programming library:

```{r, echo=FALSE}
options(width=120)
```

```{r}
suppressMessages({
  library(dplyr)
})
source("canadian.R")
```

Then define a function to calculate each team's performance for a given season.

```{r}
process_season <- function(theseason) {
  message("Processing season ", substring(theseason, 1, 4), "-",
    substring(theseason, 5, 8), "...", appendLF=FALSE)
  load(file.path("source-data", paste0("nhlscrapr-", theseason, ".RData")))
  grand.data <- tbl_df(grand.data)
  grand.data$season <- as.character(grand.data$season)

  gamestats <- grand.data %>%
    filter(ev.team %in% unique(grand.data$hometeam)) %>%
    filter(substring(gcode, 1, 1) == "2") %>%
    mutate(season==season) %>%
    group_by(season, gcode) %>%
    summarise(
      awayteam=first(awayteam),
      hometeam=first(hometeam),
      totalgoals=sum(etype == "GOAL"),
      awaygoals=sum(ev.team == awayteam & etype == "GOAL"),
      homegoals=sum(ev.team == hometeam & etype == "GOAL"),
      totalshots=sum(etype %in% c("SHOT", "GOAL")),
      awayshots=sum(ev.team == awayteam & etype %in% c("SHOT", "GOAL")),
      homeshots=sum(ev.team == hometeam & etype %in% c("SHOT", "GOAL")),
      totalfaceoffs=sum(etype == "FAC"),
      awayfaceoffs=sum(ev.team == awayteam & etype == "FAC"),
      homefaceoffs=sum(ev.team == hometeam & etype == "FAC"),
      totalpenalties=sum(etype == "PENL"),
      awaypenalties=sum(ev.team == awayteam & etype == "PENL"),
      homepenalties=sum(ev.team == hometeam & etype == "PENL"),
      awaypp=sum(ev.team == awayteam & etype == "GOAL" &
        away.skaters > home.skaters),
      homepp=sum(ev.team == hometeam & etype == "GOAL" &
        away.skaters < home.skaters),
      awaysh=sum(ev.team == awayteam & etype == "GOAL" &
        away.skaters < home.skaters),
      homesh=sum(ev.team == hometeam & etype == "GOAL" &
        away.skaters > home.skaters))

  awaygames <- gamestats %>%
    ungroup() %>%
    transmute(
      season=season,
      team=awayteam,
      goals=awaygoals / totalgoals,
      shots=awayshots / totalshots,
      faceoffs=awayfaceoffs / totalfaceoffs,
      penalties=ifelse(totalpenalties==0, NA, awaypenalties / totalpenalties),
      pp=ifelse(homepenalties==0, NA, awaypp / homepenalties),
      pk=ifelse(awaypenalties==0, NA, homepp / awaypenalties))

  homegames <- gamestats %>%
    ungroup() %>%
    transmute(
      season=season,
      team=hometeam,
      goals=homegoals / totalgoals,
      shots=homeshots / totalshots,
      faceoffs=homefaceoffs / totalfaceoffs,
      penalties=ifelse(totalpenalties==0, NA, homepenalties / totalpenalties),
      pp=ifelse(awaypenalties==0, NA, homepp / awaypenalties),
      pk=ifelse(homepenalties==0, NA, awaypp / homepenalties))

  awaystats <- awaygames %>%
    group_by(season, team) %>%
    summarise_each(funs(mean(., na.rm=TRUE)))

  homestats <- homegames %>%
    group_by(season, team) %>%
    summarise_each(funs(mean(., na.rm=TRUE)))

  overallstats <- bind_rows(awaystats, homestats) %>%
    group_by(season, team) %>%
    summarise_each(funs(mean(., na.rm=TRUE)))

  message()
  list(away=awaystats, home=homestats, overall=overallstats)
}

```

Load all available seasons and run the function on each one, combine, and save.

```{r}
load(file.path("source-data", "nhlscrapr-core.RData"))
seasons <- unique(games$season)
rm(list=c("games", "roster.master", "roster.unique"))

# separate
seasonstats <- lapply(seasons, process_season)
gamestats <- list(
  away=bind_rows(lapply(seasonstats, "[[", "away")),
  home=bind_rows(lapply(seasonstats, "[[", "home")),
  overall=bind_rows(lapply(seasonstats, "[[", "overall")))
rm(list=c("seasons", "seasonstats"))
  
saveRDS(gamestats, "processed.rds")
```

```{r, eval=FALSE}
head(gamestats[["away"]])
head(gamestats[["home"]])
head(gamestats[["overall"]])
```

```{r, echo=FALSE, results='asis'}
knitr::kable(head(gamestats[["away"]]), digits=3)
knitr::kable(head(gamestats[["home"]]), digits=3)
knitr::kable(head(gamestats[["overall"]]), digits=3)
```

Next: [3. Train models](model.html)  
Previous: [1. Scrape raw data](scrape.html)
